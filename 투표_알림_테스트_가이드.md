# 투표 마감 알림 테스트 가이드

## 수정 사항

### 1. JPQL 쿼리 수정
- `INNER JOIN BetVote bv ON bv.bet.id = b.id` → `JOIN BetVote bv ON bv.bet = b`
- JPA에서는 연관 관계를 통해 JOIN해야 합니다.

### 2. 디버깅 로그 추가
- 백엔드: `BetController`에 System.out.println 추가
- 프론트엔드: `useBetSettlementNotification`, `betApi`에 console.log 추가

## 테스트 방법

### 1. 브라우저 콘솔 확인
개발자 도구(F12) → Console 탭에서 다음 로그들을 확인하세요:

```
[useBetSettlementNotification] 정산 완료 내기 체크 시작
[betApi] API 호출: /api/bet/settled?since=...
[betApi] 토큰 존재: true/false
[betApi] 응답 상태: 200 OK
[betApi] 응답 데이터: [...]
[useBetSettlementNotification] API 응답: [...]
```

### 2. 백엔드 로그 확인
서버 콘솔에서 다음 로그를 확인하세요:

```
[BetController] 정산 완료 내기 조회 요청 - userId: X, since: ...
[BetController] 조회된 정산 완료 내기 수: X
```

### 3. 테스트 시나리오

#### 시나리오 1: 정상 동작 테스트
1. 사용자 로그인
2. 투표가 있는 게시글에 투표
3. 관리자로 로그인하여 해당 내기 정산 (`/api/bet/{betId}/settle?winnerOption=A`)
4. 1분 이내에 모달이 표시되는지 확인

#### 시나리오 2: 오프라인 후 로그인 테스트
1. 사용자 로그인
2. 투표가 있는 게시글에 투표
3. 로그아웃
4. 관리자로 로그인하여 해당 내기 정산
5. 사용자로 다시 로그인
6. 홈페이지 진입 시 모달이 표시되는지 확인

### 4. 문제 진단 체크리스트

#### 모달이 안 뜨는 경우:

1. **로그인 상태 확인**
   - 콘솔에서 `localStorage.getItem('currentUser')` 확인
   - `localStorage.getItem('accessToken')` 확인

2. **API 호출 확인**
   - Network 탭에서 `/api/bet/settled` 요청이 있는지 확인
   - 응답 상태 코드 확인 (200이어야 함)
   - 응답 데이터 확인 (배열이 비어있지 않은지)

3. **정산 상태 확인**
   - DB에서 `BET_SETTLEMENTS` 테이블에 정산 기록이 있는지 확인
   - `BET_VOTES` 테이블에 해당 사용자의 투표 기록이 있는지 확인

4. **쿼리 확인**
   - 백엔드 로그에서 "조회된 정산 완료 내기 수" 확인
   - 0이면 쿼리 문제 또는 데이터 문제

5. **로컬스토리지 확인**
   - `localStorage.getItem('betLastSeenAt')` 확인
   - `localStorage.getItem('betPendingSettlements')` 확인

### 5. 수동 테스트 쿼리

DB에서 직접 확인:

```sql
-- 사용자가 투표한 내기 중 정산 완료된 것 조회
SELECT DISTINCT b.*, bs.WINNER_OPTION, bs.SETTLED_AT
FROM BETS b
INNER JOIN BET_VOTES bv ON bv.BET_ID = b.ID
INNER JOIN BET_SETTLEMENTS bs ON bs.BET_ID = b.ID
WHERE bv.USER_ID = :userId
  AND bs.SETTLED_AT > :since
ORDER BY bs.SETTLED_AT DESC;
```

### 6. 자주 발생하는 문제

1. **JPQL 쿼리 오류**
   - `ON bv.bet.id = b.id` → `ON bv.bet = b`로 수정 완료

2. **토큰 없음**
   - 로그인 후 `accessToken`이 저장되지 않은 경우
   - `Login.jsx`에서 토큰 저장 확인

3. **정산이 안 됨**
   - 스케줄러가 실행되지 않았거나
   - 관리자가 수동 정산하지 않은 경우

4. **시간 범위 문제**
   - `since` 파라미터가 너무 최근이면 과거 정산을 놓칠 수 있음
   - 기본값: 1시간 전 (API) 또는 30일 전 (로컬스토리지)

## 다음 단계

문제가 계속되면:
1. 브라우저 콘솔 로그 전체 복사
2. 백엔드 서버 로그 확인
3. Network 탭에서 API 요청/응답 확인
4. DB에서 직접 쿼리 실행하여 데이터 확인

