# íˆ¬í‘œ ë§ˆê° ì•Œë¦¼ êµ¬í˜„ ê°€ì´ë“œ

## êµ¬í˜„ ë°©ë²• ê°œìš”

**Polling ë°©ì‹** (ê°„ë‹¨í•˜ê³  êµ¬í˜„ì´ ì‰¬ì›€):
- í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì£¼ê¸°ì ìœ¼ë¡œ ì‚¬ìš©ìê°€ íˆ¬í‘œí•œ ë‚´ê¸° ì¤‘ ì •ì‚° ì™„ë£Œëœ ê²ƒ ì²´í¬
- ì •ì‚° ì™„ë£Œëœ ë‚´ê¸°ê°€ ìˆìœ¼ë©´ ëª¨ë‹¬ í‘œì‹œ

---

## 1ë‹¨ê³„: ë°±ì—”ë“œ API ì¶”ê°€

### 1.1 BetRepositoryì— ë©”ì„œë“œ ì¶”ê°€

```java
// src/main/java/hyun/db/repo/BetRepository.java
@Repository
public interface BetRepository extends JpaRepository<Bet, Long> {
    // ... ê¸°ì¡´ ì½”ë“œ ...
    
    // ì‚¬ìš©ìê°€ íˆ¬í‘œí•œ ë‚´ê¸° ì¤‘ ì •ì‚° ì™„ë£Œëœ ê²ƒ ì¡°íšŒ
    @Query("SELECT b FROM Bet b " +
           "INNER JOIN BetVote bv ON bv.bet.id = b.id " +
           "INNER JOIN BetSettlement bs ON bs.bet.id = b.id " +
           "WHERE bv.user.id = :userId " +
           "AND bs.settledAt > :since " +
           "ORDER BY bs.settledAt DESC")
    List<Bet> findSettledBetsByUserVote(@Param("userId") Long userId, 
                                         @Param("since") Instant since);
}
```

### 1.2 BetServiceì— ë©”ì„œë“œ ì¶”ê°€

```java
// src/main/java/hyun/auth/service/BetService.java
@Service
@RequiredArgsConstructor
@Slf4j
public class BetService {
    // ... ê¸°ì¡´ ì½”ë“œ ...
    
    /**
     * ì‚¬ìš©ìê°€ íˆ¬í‘œí•œ ë‚´ê¸° ì¤‘ ìµœê·¼ ì •ì‚° ì™„ë£Œëœ ê²ƒ ì¡°íšŒ
     * @param userId ì‚¬ìš©ì ID
     * @param since ì´ ì‹œê° ì´í›„ ì •ì‚°ëœ ê²ƒë§Œ ì¡°íšŒ (ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€)
     * @return ì •ì‚° ì™„ë£Œëœ ë‚´ê¸° ëª©ë¡
     */
    public List<Bet> getSettledBetsByUserVote(Long userId, Instant since) {
        return betRepository.findSettledBetsByUserVote(userId, since);
    }
}
```

### 1.3 BetControllerì— API ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€

```java
// src/main/java/hyun/auth/controller/BetController.java
@RestController
@RequestMapping("/api/bet")
@RequiredArgsConstructor
public class BetController {
    private final BetService betService;
    private final UserRepository userRepository;
    
    // ... ê¸°ì¡´ ì½”ë“œ ...
    
    /**
     * ì‚¬ìš©ìê°€ íˆ¬í‘œí•œ ë‚´ê¸° ì¤‘ ì •ì‚° ì™„ë£Œëœ ê²ƒ ì¡°íšŒ
     * @param since ì´ ì‹œê° ì´í›„ ì •ì‚°ëœ ê²ƒë§Œ ì¡°íšŒ (ISO 8601 í˜•ì‹, ì˜ˆ: "2024-01-15T10:00:00Z")
     */
    @GetMapping("/settled")
    public ResponseEntity<List<Map<String, Object>>> getSettledBets(
            @RequestParam(required = false) String since) {
        
        // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì¡°íšŒ
        String username = SecurityContextHolder.getContext().getAuthentication().getName();
        User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new RuntimeException("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        
        // since íŒŒë¼ë¯¸í„° íŒŒì‹± (ì—†ìœ¼ë©´ 1ì‹œê°„ ì „ë¶€í„°)
        Instant sinceInstant = since != null 
            ? Instant.parse(since) 
            : Instant.now().minusSeconds(3600);
        
        List<Bet> settledBets = betService.getSettledBetsByUserVote(user.getId(), sinceInstant);
        
        // ì‘ë‹µ í˜•ì‹ ë³€í™˜
        List<Map<String, Object>> result = settledBets.stream()
            .map(bet -> {
                Map<String, Object> map = new HashMap<>();
                map.put("betId", bet.getId());
                map.put("betTitle", bet.getBetTitle());
                map.put("optionA", bet.getOptionA());
                map.put("optionB", bet.getOptionB());
                map.put("postId", bet.getPost().getId());
                
                // ì •ì‚° ì •ë³´ ì¡°íšŒ
                BetSettlement settlement = betSettlementRepository.findByBet(bet)
                    .orElse(null);
                if (settlement != null) {
                    map.put("winnerOption", settlement.getWinnerOption());
                    map.put("settledAt", settlement.getSettledAt().toString());
                }
                
                return map;
            })
            .collect(Collectors.toList());
        
        return ResponseEntity.ok(result);
    }
}
```

---

## 2ë‹¨ê³„: í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„

### 2.1 API í•¨ìˆ˜ ì¶”ê°€

```javascript
// front/src/data/communityApi.js ë˜ëŠ” ìƒˆë¡œìš´ betApi.js íŒŒì¼ ìƒì„±

// front/src/data/betApi.js (ìƒˆ íŒŒì¼)
import backendApi from './api';

const betApi = {
  // ì‚¬ìš©ìê°€ íˆ¬í‘œí•œ ë‚´ê¸° ì¤‘ ì •ì‚° ì™„ë£Œëœ ê²ƒ ì¡°íšŒ
  getSettledBets: (since) => {
    return new Promise(async (resolve, reject) => {
      try {
        const url = since 
          ? `/api/bet/settled?since=${encodeURIComponent(since)}`
          : '/api/bet/settled';
        const response = await fetch(`${backendApi.baseUrl}${url}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });
        
        if (!response.ok) {
          throw new Error('ì •ì‚° ì™„ë£Œ ë‚´ê¸° ì¡°íšŒ ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        resolve(data);
      } catch (error) {
        console.error('ì •ì‚° ì™„ë£Œ ë‚´ê¸° ì¡°íšŒ ì‹¤íŒ¨:', error);
        reject(error);
      }
    });
  }
};

export default betApi;
```

### 2.2 ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸ ìƒì„±

```javascript
// front/src/components/common/BetSettlementModal.jsx
import React from 'react';
import { useNavigate } from 'react-router-dom';
import '../../styles/community.css';

function BetSettlementModal({ bet, onClose }) {
  const navigate = useNavigate();
  
  if (!bet) return null;
  
  const handleViewPost = () => {
    navigate(`/community/post/${bet.postId}`);
    onClose();
  };
  
  const winnerText = bet.winnerOption === 'A' ? bet.optionA : bet.optionB;
  
  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h3>ğŸ‰ íˆ¬í‘œê°€ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤!</h3>
          <button className="modal-close" onClick={onClose}>Ã—</button>
        </div>
        
        <div className="modal-body">
          <p><strong>{bet.betTitle}</strong></p>
          <div style={{ marginTop: '15px', padding: '10px', backgroundColor: '#f0f0f0', borderRadius: '5px' }}>
            <p>ìŠ¹ë¦¬ ì˜µì…˜: <strong style={{ color: '#28a745' }}>{winnerText}</strong></p>
            <p style={{ fontSize: '12px', color: '#666', marginTop: '5px' }}>
              ì •ì‚° ì‹œê°: {new Date(bet.settledAt).toLocaleString('ko-KR')}
            </p>
          </div>
        </div>
        
        <div className="modal-footer">
          <button onClick={handleViewPost} className="btn-primary">
            ê²Œì‹œê¸€ ë³´ê¸°
          </button>
          <button onClick={onClose} className="btn-secondary">
            ë‹«ê¸°
          </button>
        </div>
      </div>
    </div>
  );
}

export default BetSettlementModal;
```

### 2.3 ì»¤ìŠ¤í…€ í›… ìƒì„±

```javascript
// front/src/hooks/useBetSettlementNotification.js
import { useEffect, useState, useRef } from 'react';
import betApi from '../data/betApi';

/**
 * íˆ¬í‘œ ë§ˆê° ì•Œë¦¼ì„ ìœ„í•œ ì»¤ìŠ¤í…€ í›…
 * @param {string} currentUser í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì
 * @param {number} checkInterval ì²´í¬ ì£¼ê¸° (ë°€ë¦¬ì´ˆ, ê¸°ë³¸ê°’: 60000 = 1ë¶„)
 */
function useBetSettlementNotification(currentUser, checkInterval = 60000) {
  const [settledBets, setSettledBets] = useState([]);
  const [showModal, setShowModal] = useState(false);
  const [currentBet, setCurrentBet] = useState(null);
  const lastCheckTimeRef = useRef(new Date().toISOString());
  const checkedBetIdsRef = useRef(new Set()); // ì´ë¯¸ ì•Œë¦¼ì„ ë„ìš´ ë‚´ê¸° ID ì €ì¥
  
  useEffect(() => {
    if (!currentUser) {
      return; // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° ì²´í¬í•˜ì§€ ì•ŠìŒ
    }
    
    const checkSettledBets = async () => {
      try {
        // ë§ˆì§€ë§‰ ì²´í¬ ì‹œê° ì´í›„ ì •ì‚°ëœ ë‚´ê¸°ë§Œ ì¡°íšŒ
        const since = lastCheckTimeRef.current;
        const newSettledBets = await betApi.getSettledBets(since);
        
        if (newSettledBets && newSettledBets.length > 0) {
          // ì•„ì§ ì•Œë¦¼ì„ ë„ìš°ì§€ ì•Šì€ ë‚´ê¸°ë§Œ í•„í„°ë§
          const unreadBets = newSettledBets.filter(
            bet => !checkedBetIdsRef.current.has(bet.betId)
          );
          
          if (unreadBets.length > 0) {
            // ì²« ë²ˆì§¸ ì •ì‚° ì™„ë£Œ ë‚´ê¸°ì— ëŒ€í•´ ëª¨ë‹¬ í‘œì‹œ
            const firstBet = unreadBets[0];
            setCurrentBet(firstBet);
            setShowModal(true);
            
            // ì•Œë¦¼ì„ ë„ìš´ ë‚´ê¸° ID ì €ì¥
            unreadBets.forEach(bet => {
              checkedBetIdsRef.current.add(bet.betId);
            });
          }
        }
        
        // ë§ˆì§€ë§‰ ì²´í¬ ì‹œê° ì—…ë°ì´íŠ¸
        lastCheckTimeRef.current = new Date().toISOString();
      } catch (error) {
        console.error('ì •ì‚° ì™„ë£Œ ë‚´ê¸° ì²´í¬ ì‹¤íŒ¨:', error);
      }
    };
    
    // ì¦‰ì‹œ í•œ ë²ˆ ì²´í¬
    checkSettledBets();
    
    // ì£¼ê¸°ì ìœ¼ë¡œ ì²´í¬
    const intervalId = setInterval(checkSettledBets, checkInterval);
    
    return () => {
      clearInterval(intervalId);
    };
  }, [currentUser, checkInterval]);
  
  const closeModal = () => {
    setShowModal(false);
    setCurrentBet(null);
  };
  
  return {
    showModal,
    currentBet,
    closeModal
  };
}

export default useBetSettlementNotification;
```

### 2.4 App.jsx ë˜ëŠ” ë©”ì¸ ë ˆì´ì•„ì›ƒì— ì ìš©

```javascript
// front/src/App.jsx ë˜ëŠ” main.jsx
import React from 'react';
import { Outlet, useLocation } from 'react-router-dom';
import { useState, useEffect } from 'react';
import useBetSettlementNotification from './hooks/useBetSettlementNotification';
import BetSettlementModal from './components/common/BetSettlementModal';

function App() {
  const [currentUser, setCurrentUser] = useState(null);
  const location = useLocation();
  
  // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
  useEffect(() => {
    const token = localStorage.getItem('token');
    const username = localStorage.getItem('username');
    if (token && username) {
      setCurrentUser(username);
    } else {
      setCurrentUser(null);
    }
  }, [location]);
  
  // íˆ¬í‘œ ë§ˆê° ì•Œë¦¼ í›… ì‚¬ìš©
  const { showModal, currentBet, closeModal } = useBetSettlementNotification(
    currentUser,
    60000 // 1ë¶„ë§ˆë‹¤ ì²´í¬
  );
  
  return (
    <>
      <Outlet />
      {showModal && (
        <BetSettlementModal bet={currentBet} onClose={closeModal} />
      )}
    </>
  );
}

export default App;
```

---

## 3ë‹¨ê³„: ìŠ¤íƒ€ì¼ ì¶”ê°€

```css
/* front/src/styles/community.cssì— ì¶”ê°€ */

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal-content {
  background: white;
  border-radius: 8px;
  padding: 0;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid #e0e0e0;
}

.modal-header h3 {
  margin: 0;
  font-size: 1.2em;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #666;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-close:hover {
  color: #000;
}

.modal-body {
  padding: 20px;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  padding: 20px;
  border-top: 1px solid #e0e0e0;
}

.btn-primary {
  background-color: #007bff;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 5px;
  cursor: pointer;
}

.btn-primary:hover {
  background-color: #0056b3;
}

.btn-secondary {
  background-color: #6c757d;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 5px;
  cursor: pointer;
}

.btn-secondary:hover {
  background-color: #545b62;
}
```

---

## ë™ì‘ íë¦„

1. **ì‚¬ìš©ì ë¡œê·¸ì¸** â†’ `currentUser` ìƒíƒœ ì„¤ì •
2. **í›… ì‹¤í–‰** â†’ `useBetSettlementNotification` í›…ì´ 1ë¶„ë§ˆë‹¤ ì²´í¬ ì‹œì‘
3. **API í˜¸ì¶œ** â†’ `/api/bet/settled` ì—”ë“œí¬ì¸íŠ¸ë¡œ ì •ì‚° ì™„ë£Œ ë‚´ê¸° ì¡°íšŒ
4. **ì •ì‚° ì™„ë£Œ ë‚´ê¸° ë°œê²¬** â†’ ëª¨ë‹¬ í‘œì‹œ
5. **ì‚¬ìš©ì ì•¡ì…˜**:
   - "ê²Œì‹œê¸€ ë³´ê¸°" í´ë¦­ â†’ í•´ë‹¹ ê²Œì‹œê¸€ í˜ì´ì§€ë¡œ ì´ë™
   - "ë‹«ê¸°" í´ë¦­ â†’ ëª¨ë‹¬ ë‹«ê¸°
6. **ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€** â†’ ì´ë¯¸ ì•Œë¦¼ì„ ë„ìš´ ë‚´ê¸°ëŠ” `checkedBetIdsRef`ì— ì €ì¥í•˜ì—¬ ë‹¤ì‹œ í‘œì‹œí•˜ì§€ ì•ŠìŒ

---

## ê°œì„  ì‚¬í•­ (ì„ íƒ)

1. **ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì²´í¬ ì‹œê° ì €ì¥**: í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ í›„ì—ë„ ì´ì „ì— ì²´í¬í•œ ì‹œê° ìœ ì§€
2. **ì—¬ëŸ¬ ì •ì‚° ì™„ë£Œ ë‚´ê¸° ì²˜ë¦¬**: í•˜ë‚˜ì”© ìˆœì°¨ì ìœ¼ë¡œ ëª¨ë‹¬ í‘œì‹œ
3. **WebSocket ì‚¬ìš©**: ì‹¤ì‹œê°„ ì•Œë¦¼ (ë” ë³µì¡í•˜ì§€ë§Œ ì¦‰ì‹œ ì•Œë¦¼ ê°€ëŠ¥)

